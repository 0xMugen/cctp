# Testing Workflow
#
# This workflow runs the complete test suite including:
# - Unit tests with Vitest
# - Browser tests with Playwright
# - Integration tests
#
# Tests run against PostgreSQL database for realistic testing conditions.

name: Test

on:
  workflow_call: # Allow this workflow to be called by other workflows

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_USER: testuser
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    env:
      DATABASE_URL: postgresql://testuser:testpass@localhost:5432/testdb
      NODE_ENV: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'

      - name: Install PostgreSQL client tools
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client-16

      - name: Verify setup
        run: |
          echo 'Node.js version:' && node --version
          echo 'pnpm version:' && pnpm --version
          echo 'PostgreSQL client version:' && psql --version

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile

      - name: Wait for PostgreSQL
        run: |
          echo "ðŸ”„ Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 -U testuser; then
              echo "âœ… PostgreSQL is ready!"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done

      - name: Run database migrations
        run: |
          echo "ðŸ—„ï¸ Running database migrations..."
          pnpm run migrate:up

      - name: Run unit tests
        run: |
          echo "ðŸ§ª Running unit tests with Vitest..."
          pnpm run test

      - name: Build application for integration tests
        run: |
          echo "ðŸ—ï¸ Building application for integration tests..."
          pnpm run build

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            coverage/
            test-results/
          retention-days: 7

      - name: Test summary
        if: success()
        run: |
          echo "## âœ… Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All tests completed successfully:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Unit tests (Vitest)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Database migrations" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build verification" >> $GITHUB_STEP_SUMMARY

      - name: Test failure summary
        if: failure()
        run: |
          echo "## âŒ Tests Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Some tests failed. Please review the logs above and fix the issues." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Debugging tips:**" >> $GITHUB_STEP_SUMMARY
          echo "- Check the test results artifact for detailed logs" >> $GITHUB_STEP_SUMMARY
          echo "- Run \`pnpm run test\` locally to reproduce issues" >> $GITHUB_STEP_SUMMARY
          echo "- Ensure database migrations are up to date with \`pnpm run migrate:up\`" >> $GITHUB_STEP_SUMMARY
